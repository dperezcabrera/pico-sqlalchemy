name: Sync Project Keywords to Repo Labels

on:
  push:
    branches:
      - main
    paths:
      - 'pyproject.toml'
      - '.github/workflows/sync-labels.yml'
  workflow_dispatch:

jobs:
  sync_labels:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install TOML parser
        run: pip install toml

      - name: Extract & Format Keywords from pyproject.toml
        id: extract_keywords
        run: |
          python << 'PY'
          import toml
          import json
          import os

          COLOR_MAP = {
              'ioc': '006090',
              'di': '006090',
              'python': '3776AB',
              'async': 'E34848',
              'minimalistic': 'BFD4F2',
          }

          with open('pyproject.toml', 'r', encoding='utf-8') as f:
              data = toml.load(f)

          keywords = data.get('project', {}).get('keywords', [])

          formatted_labels = []
          for keyword in keywords:
              color = COLOR_MAP.get(keyword.lower(), 'B6B6B6')
              description = f'Automatically synced from pyproject.toml keyword: {keyword}'
              formatted_labels.append({
                  'name': keyword,
                  'color': color,
                  'description': description,
              })

          labels_json = json.dumps(formatted_labels)

          github_output = os.environ["GITHUB_OUTPUT"]
          with open(github_output, "a", encoding="utf-8") as fh:
              print(f"labels_json={labels_json}", file=fh)
          PY

      - name: Write labels config file
        run: |
          mkdir -p .github
          echo '${{ steps.extract_keywords.outputs.labels_json }}' > .github/labels.generated.json

      - name: Sync Labels to Repository
        uses: EndBug/label-sync@v2
        with:
          config-file: .github/labels.generated.json
          token: ${{ secrets.GITHUB_TOKEN }}
          delete-other-labels: true

